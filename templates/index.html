<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم ردیابی فوق‌سنگین کاسه‌ها</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #212529;
            --light: #f8f9fa;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .gradient-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 3rem 0;
            margin-bottom: 3rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .upload-container {
            background: white;
            border-radius: 15px;
            padding: 2.5rem;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            border: 3px dashed #e9ecef;
        }
        
        .upload-container:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(67, 97, 238, 0.15);
        }
        
        .progress-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: none;
        }
        
        .result-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            display: none;
        }
        
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 10px;
            background: #000;
            margin-bottom: 1.5rem;
        }
        
        .video-wrapper video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .progress-bar {
            height: 12px;
            border-radius: 6px;
            transition: width 0.6s ease;
        }
        
        .symbol-preview {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .symbol {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .symbol-plus {
            color: var(--success);
            border: 3px solid var(--success);
        }
        
        .symbol-minus {
            color: var(--danger);
            border: 3px solid var(--danger);
        }
        
        .symbol-cross {
            color: var(--warning);
            border: 3px solid var(--warning);
        }
        
        .file-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        
        .status-message {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .drag-active {
            border-color: var(--primary) !important;
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        @media (max-width: 768px) {
            .gradient-header {
                padding: 2rem 0;
            }
            
            .upload-container, .progress-container, .result-container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- هدر -->
    <div class="gradient-header">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center">
                    <h1 class="display-4 fw-bold mb-3">سیستم ردیابی فوق‌سنگین کاسه‌ها</h1>
                    <p class="lead mb-0">پردازش ویدئو با دقت فوق‌العاده و ردیابی بدون خطا</p>
                </div>
            </div>
        </div>
    </div>

    <!-- محتوای اصلی -->
    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- بخش آپلود -->
                <div class="upload-container" id="uploadSection">
                    <div class="text-center">
                        <i class="fas fa-video fa-4x mb-4" style="color: var(--primary);"></i>
                        <h3 class="mb-3">ویدئوی خود را آپلود کنید</h3>
                        <p class="text-muted mb-4">فرمت‌های مجاز: MP4, AVI, MOV, MKV (حداکثر ۲GB)</p>
                        
                        <button class="btn btn-primary btn-lg px-4 mb-3" id="uploadBtn">
                            <i class="fas fa-upload me-2"></i>انتخاب فایل
                        </button>
                        <input type="file" id="fileInput" accept="video/*" class="d-none">
                        
                        <p class="text-muted">یا فایل را اینجا رها کنید</p>
                    </div>
                    
                    <div class="file-info d-none" id="fileInfo">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-video me-3 fa-2x text-primary"></i>
                            <div>
                                <h6 class="mb-1" id="fileName">نام فایل</h6>
                                <small class="text-muted" id="fileSize">اندازه فایل</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- پیش‌نمایش علامت‌ها -->
                <div class="symbol-preview">
                    <div class="symbol symbol-plus">➕</div>
                    <div class="symbol symbol-minus">➖</div>
                    <div class="symbol symbol-cross">✖️</div>
                </div>
                
                <!-- بخش پیشرفت -->
                <div class="progress-container" id="progressSection">
                    <h4 class="mb-3">در حال پردازش ویدئو</h4>
                    <div class="status-message" id="statusMessage">در حال آماده‌سازی...</div>
                    
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between text-muted mb-3">
                        <small id="progressText">0%</small>
                        <small id="timeRemaining">زمان باقیمانده: محاسبه...</small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <small id="currentFrame">فریم 0</small>
                        <small id="totalFrames">از 0 فریم</small>
                    </div>
                </div>
                
                <!-- بخش نتایج -->
                <div class="result-container" id="resultSection">
                    <h4 class="mb-3">نتایج پردازش</h4>
                    <div class="video-wrapper">
                        <video id="processedVideo" controls></video>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="#" id="downloadBtn" class="btn btn-success btn-lg">
                            <i class="fas fa-download me-2"></i>دانلود ویدئو پردازش شده
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // عناصر DOM
            const uploadSection = document.getElementById('uploadSection');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const progressSection = document.getElementById('progressSection');
            const resultSection = document.getElementById('resultSection');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');
            const timeRemaining = document.getElementById('timeRemaining');
            const currentFrame = document.getElementById('currentFrame');
            const totalFrames = document.getElementById('totalFrames');
            const processedVideo = document.getElementById('processedVideo');
            const downloadBtn = document.getElementById('downloadBtn');
            
            let currentFilename = '';
            let startTime = 0;
            let progressInterval;
            
            // مدیریت کشیدن و رها کردن فایل
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-active');
            });
            
            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('drag-active');
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-active');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelection();
                }
            });
            
            // مدیریت کلیک روی دکمه آپلود
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // مدیریت انتخاب فایل
            fileInput.addEventListener('change', handleFileSelection);
            
            // تابع مدیریت انتخاب فایل
            function handleFileSelection() {
                if (fileInput.files.length === 0) return;
                
                const file = fileInput.files[0];
                
                // نمایش اطلاعات فایل
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.classList.remove('d-none');
                
                // شروع پردازش
                startProcessing(file);
            }
            
            // تابع شروع پردازش
            function startProcessing(file) {
                // تنظیم حالت اولیه
                currentFilename = '';
                uploadSection.style.display = 'none';
                progressSection.style.display = 'block';
                resultSection.style.display = 'none';
                
                // نمایش وضعیت اولیه
                updateProgressUI({
                    progress: 0,
                    message: 'در حال آماده‌سازی...',
                    current_frame: 0,
                    total_frames: 0
                });
                
                // زمان شروع
                startTime = Date.now();
                
                // ایجاد FormData
                const formData = new FormData();
                formData.append('video', file);
                
                // تنظیم timeout برای درخواست
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000); // 30 ثانیه
                
                // ارسال فایل به سرور
                fetch('/upload', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeout);
                    if (!response.ok) {
                        throw new Error(`خطای HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    currentFilename = data.filename;
                    
                    // شروع چک کردن پیشرفت
                    startProgressCheck();
                })
                .catch(error => {
                    clearTimeout(timeout);
                    showError(`خطا در آپلود: ${error.message}`);
                    resetUI();
                    console.error('Upload error:', error);
                });
            }
            
            // تابع شروع چک کردن پیشرفت
            function startProgressCheck() {
                // توقف اینتروال قبلی اگر وجود دارد
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                // چک کردن پیشرفت هر 1 ثانیه
                progressInterval = setInterval(() => {
                    checkProgress();
                }, 1000);
            }
            
            // تابع چک کردن پیشرفت
            function checkProgress() {
                if (!currentFilename) {
                    clearInterval(progressInterval);
                    return;
                }
                
                fetch(`/progress/${currentFilename}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('خطا در دریافت وضعیت پردازش');
                    }
                    return response.json();
                })
                .then(data => {
                    // به‌روزرسانی UI بر اساس داده‌های دریافتی
                    updateProgressUI(data);
                    
                    // مدیریت وضعیت‌های مختلف
                    if (data.status === 'completed') {
                        processingCompleted(data);
                    } else if (data.status === 'error') {
                        processingError(data);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                });
            }
            
            // تابع به‌روزرسانی UI بر اساس پیشرفت
            function updateProgressUI(data) {
                // به‌روزرسانی نوار پیشرفت
                const progress = data.progress || 0;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;
                
                // به‌روزرسانی پیام وضعیت
                if (data.message) {
                    statusMessage.textContent = data.message;
                }
                
                // به‌روزرسانی اطلاعات فریم
                if (data.current_frame !== undefined && data.total_frames !== undefined) {
                    currentFrame.textContent = `فریم ${data.current_frame}`;
                    totalFrames.textContent = `از ${data.total_frames} فریم`;
                }
                
                // محاسبه زمان باقیمانده
                if (progress > 0 && data.current_frame > 0 && data.total_frames > 0) {
                    const elapsed = (Date.now() - startTime) / 1000; // ثانیه
                    const remaining = (elapsed / progress) * (100 - progress);
                    timeRemaining.textContent = `زمان باقیمانده: ${formatTime(remaining)}`;
                }
                
                // تغییر رنگ نوار پیشرفت بر اساس درصد
                if (progress < 30) {
                    progressBar.classList.remove('bg-success', 'bg-warning');
                    progressBar.classList.add('bg-danger');
                } else if (progress < 70) {
                    progressBar.classList.remove('bg-danger', 'bg-success');
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.remove('bg-danger', 'bg-warning');
                    progressBar.classList.add('bg-success');
                }
            }
            
            // تابع تکمیل پردازش
            function processingCompleted(data) {
                clearInterval(progressInterval);
                
                // نمایش بخش نتایج
                progressSection.style.display = 'none';
                resultSection.style.display = 'block';
                
                // تنظیم ویدئوی پردازش شده
                processedVideo.src = `/processed/${currentFilename}`;
                
                // تنظیم لینک دانلود
                downloadBtn.href = `/processed/${currentFilename}`;
                downloadBtn.download = `processed_${currentFilename.split('_').slice(1).join('_')}`;
                
                // اسکرول به نتایج
                resultSection.scrollIntoView({ behavior: 'smooth' });
                
                // نمایش زمان پردازش
                if (data.processing_time) {
                    statusMessage.textContent = `پردازش در ${data.processing_time.toFixed(2)} ثانیه تکمیل شد`;
                }
            }
            
            // تابع خطای پردازش
            function processingError(data) {
                clearInterval(progressInterval);
                showError(data.message || 'خطا در پردازش ویدئو');
                resetUI();
            }
            
            // تابع نمایش خطا
            function showError(message) {
                // ایجاد اعلان خطا
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                `;
                
                // اضافه کردن به بخش آپلود
                uploadSection.appendChild(alertDiv);
                
                // حذف خودکار پس از 5 ثانیه
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
            
            // تابع بازنشانی UI
            function resetUI() {
                uploadSection.style.display = 'block';
                progressSection.style.display = 'none';
                resultSection.style.display = 'none';
                fileInfo.classList.add('d-none');
                fileInput.value = '';
            }
            
            // تابع فرمت‌دهی اندازه فایل
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 بایت';
                const k = 1024;
                const sizes = ['بایت', 'کیلوبایت', 'مگابایت', 'گیگابایت'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // تابع فرمت‌دهی زمان
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins} دقیقه و ${secs} ثانیه`;
            }
        });
    </script>
</body>
  </html>
